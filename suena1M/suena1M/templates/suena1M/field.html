{% extends 'suena1M/game.html' %}
{% block field %}
{% for message in messages %}
<div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}

<div class="row">
    {% if players.0 %}
        <div class="col-sm-8">{{players.0.name}}</div>
    {% else %}
        <div class="col-sm-8"></div>    
    {% endif %}    
    {% if players.1 %}
        <div class="col-sm-4">{{players.1.name}}</div>
    {% else %}
        <div class="col-sm-4"></div> 
    {% endif %}    
</div>
<div class="row">
    <div class="col-sm"></div>
    <div class="col-sm">col-sm</div>
    <div class="col-sm"></div>
</div>
<div class="row">
    {% if players.2 %}
        <div class="col-sm-8">{{players.2.name}}</div>
    {% else %}
        <div class="col-sm-8"></div> 
    {% endif %}    
    {% if players.3 %}
        <div class="col-sm-4">{{players.3.name}}</div>
    {% else %}
        <div class="col-sm-4"></div> 
    {% endif %}    
</div>

<table class="table table-striped table-dark">
    <thead class="thead-light">
      <tr>
        <th scope="col">Spieler</th>
        <th scope="col">Total Revenue</th>
        <th scope="col">Day Revenue</th>
        <th scope="col">Dayahead Bad</th>
        <th scope="col">Intraday Market Bad</th>
      </tr>
    </thead>
    <tbody>
    {% for player in players %}
      <tr>
        <th scope="row">{{player.name}}</th>
        <td>{{player.game_score}}</td>
        <td>{{player.round_score}}</td>
        <td>{{player.dam}}</td>
        <td>{{player.idm}}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  
<!-- <div>
    <textarea id="chat-log" cols="50" rows="20" size="100"></textarea>
    <div class="input-group mb-3">
        <input id="chat-message-input" type="text" class="form-control">
        <input id="chat-message-submit" type="button" value="Senden" class="btn btn-primary">
    </div>
</div> -->

{{ object.slug|json_script:"game-slug" }}
{{ player_name|json_script:"player-name" }}
<script>
    const gameSlug = JSON.parse(document.getElementById('game-slug').textContent);
    const playerName = JSON.parse(document.getElementById('player-name').textContent);
    console.log("gameSlug: " + gameSlug);
    console.log("playerName: " + playerName);

    const gameSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/game/'
        + gameSlug
        + '/'
    );

    gameSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        document.querySelector('#chat-log').value += (data.message + '\n');
    };

    gameSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        gameSocket.send(JSON.stringify({
            'message': message,
            'player_name': playerName,
        }));
        messageInputDom.value = '';
    };
</script>
{% endblock %}